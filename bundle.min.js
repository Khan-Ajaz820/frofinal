!function(){let t="undefined"!=typeof window?window:self,e=null,o=null;async function l(l="build/full_mosaic.wasm"){let n=await fetch(l);if(!n.ok)throw Error("Failed to fetch wasm: "+n.statusText);let a=await n.arrayBuffer(),r={env:{abort(t,e,o,l){console.error("abort called at index.ts:"+o+":"+l)},seed:Date.now}},{instance:i}=await WebAssembly.instantiate(a,r);return e=i,o=i.exports,t.wasmReady=!0,o}async function n(e="kd_tree.json"){if(!o)throw Error("WASM not loaded");let l=await fetch(e);if(!l.ok)throw Error("Failed to fetch kd_tree.json: "+l.statusText);let n=await l.json(),a=[],r=new Map;t.emojiSrcs=[];let i=function e(o){if(!o)return -1;let l=o.left?e(o.left):-1,n=o.right?e(o.right):-1,i=-1;if(o.point&&o.point.src){let s=o.point.src;r.has(s)?i=r.get(s):(i=t.emojiSrcs.length,t.emojiSrcs.push(s),r.set(s,i))}let $=o.point&&o.point.avg?o.point.avg:[0,0,0],u="number"==typeof o.axis?o.axis:0,f=a.length;return a.push({avg:$,left:l,right:n,axis:u,srcIndex:i}),f}(n);o.initNodeCount(0|a.length);for(let s=0;s<a.length;s++){let $=a[s];o.setNodeAt(0|s,$.avg[0]||0,$.avg[1]||0,$.avg[2]||0,0|$.left,0|$.right,0|$.axis,0|$.srcIndex)}return o.setRootIndex(0|i),{nodesCount:a.length,rootIndex:i,emojiSrcs:t.emojiSrcs}}t.emojiSrcs=[],t.wasmReady=!1,t.loadWasmModule=l,t.loadKDTreeIntoWasm=n,t.calculateTileColorsFromCanvas=function t(e,o=16){let l=e.getContext("2d"),n=e.width,a=e.height,r=Math.floor(n/o),i=Math.floor(a/o),s=[];for(let $=0;$<i;$++)for(let u=0;u<r;u++){let f=u*o,d=$*o,c=l.getImageData(f,d,o,o),h=c.data,g=0,m=0,w=0,p=0;for(let x=0;x<h.length;x+=4){let j=h[x+3];0!==j&&(g+=h[x],m+=h[x+1],w+=h[x+2],p++)}0===p?s.push([0,0,0]):s.push([g/p,m/p,w/p])}return{colors:s,cols:r,rows:i}},t.runMatchingAndGetResults=function e(l){if(!o)throw Error("WASM not loaded");let n=0|l.length;o.initTileCount(n);for(let a=0;a<n;a++){let r=l[a];o.setTileColorAt(0|a,r[0],r[1],r[2])}o.processAll();let i=Array(n);for(let s=0;s<n;s++){let $=o.getResultAt(0|s);i[s]=$>=0&&$<t.emojiSrcs.length?t.emojiSrcs[$]:null}return i}}();
const track=document.getElementById("galleryTrack"),prevBtn=document.getElementById("sliderPrev"),nextBtn=document.getElementById("sliderNext"),dotsContainer=document.getElementById("sliderDots"),slides=document.querySelectorAll(".gallery-slide");let currentIndex=0,slidesPerView=3,slideGap=30;function updateSlidesPerView(){window.innerWidth<=768?(slidesPerView=1,slideGap=20):window.innerWidth<=1024?(slidesPerView=2,slideGap=30):(slidesPerView=3,slideGap=30)}function createDots(){dotsContainer.innerHTML="";let e=Math.ceil(slides.length-slidesPerView+1);for(let t=0;t<e;t++){let l=document.createElement("div");l.classList.add("dot"),0===t&&l.classList.add("active"),l.addEventListener("click",()=>goToSlide(t)),dotsContainer.appendChild(l)}}function updateDots(){let e=document.querySelectorAll(".dot");e.forEach((e,t)=>{e.classList.toggle("active",t===currentIndex)})}function goToSlide(e){let t=slides.length-slidesPerView;currentIndex=Math.max(0,Math.min(e,t));let l=track.offsetWidth/slidesPerView,n=-(currentIndex*(l+slideGap));track.style.transform=`translateX(${n}px)`,updateDots()}function nextSlide(){let e=slides.length-slidesPerView;currentIndex<e&&goToSlide(++currentIndex)}function prevSlide(){currentIndex>0&&goToSlide(--currentIndex)}prevBtn.addEventListener("click",prevSlide),nextBtn.addEventListener("click",nextSlide);let touchStartX=0,touchEndX=0;function handleSwipe(){touchStartX-touchEndX>50&&nextSlide(),touchEndX-touchStartX>50&&prevSlide()}track.addEventListener("touchstart",e=>{touchStartX=e.touches[0].clientX}),track.addEventListener("touchend",e=>{touchEndX=e.changedTouches[0].clientX,handleSwipe()});let autoplayInterval;function startAutoplay(){autoplayInterval=setInterval(()=>{currentIndex>=slides.length-slidesPerView?currentIndex=0:currentIndex++,goToSlide(currentIndex)},4e3)}function stopAutoplay(){clearInterval(autoplayInterval)}updateSlidesPerView(),createDots(),goToSlide(0),startAutoplay();const sliderWrapper=document.querySelector(".gallery-slider-wrapper");sliderWrapper.addEventListener("mouseenter",stopAutoplay),sliderWrapper.addEventListener("mouseleave",startAutoplay),window.addEventListener("resize",()=>{updateSlidesPerView(),createDots(),currentIndex=0,goToSlide(0)});const faqItems=document.querySelectorAll(".faq-item");function syncButtonStates(e,t){let l=new MutationObserver(()=>{t.innerHTML=e.innerHTML,t.disabled=e.disabled,t.style.opacity=e.style.opacity,t.style.cursor=e.style.cursor});l.observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!0})}faqItems.forEach(e=>{let t=e.querySelector(".faq-question");t.addEventListener("click",()=>{let t=e.classList.contains("active");faqItems.forEach(t=>{t!==e&&t.classList.remove("active")}),t?e.classList.remove("active"):e.classList.add("active")})}),function(){let e=document.getElementById("lightboxModal"),t=document.getElementById("lightboxImage"),l=document.getElementById("lightboxClose"),n=document.getElementById("zoomIn"),o=document.getElementById("zoomOut"),a=document.getElementById("zoomReset"),i=1,s=document.createElement("div");s.className="lightbox-loading",s.innerHTML="⏳ Loading High-Res Image...",e.appendChild(s);let r=document.querySelectorAll(".slide-card");function d(){e.classList.remove("active"),document.body.style.overflow="",s.style.display="none",s.innerHTML="⏳ Loading High-Res Image...",s.style.color="#00d4ff",setTimeout(()=>{t.src="",t.style.opacity="1",t.style.display="block",i=1},300)}r.forEach(l=>{l.addEventListener("click",function(){let l=this.getAttribute("data-image");if(l){e.classList.add("active"),document.body.style.overflow="hidden",s.style.display="flex",t.style.opacity="0",t.style.display="none";let n=new Image;n.onload=function(){t.src=l,t.style.display="block",setTimeout(()=>{t.style.opacity="1",s.style.display="none"},100),i=1,t.style.transform=`scale(${i})`},n.onerror=function(){s.innerHTML="❌ Failed to Load Image",s.style.color="#ff4444",setTimeout(()=>{d()},2e3)},n.src=l}})}),l.addEventListener("click",d),e.addEventListener("click",function(t){t.target===e&&d()}),document.addEventListener("keydown",function(t){"Escape"===t.key&&e.classList.contains("active")&&d()}),n.addEventListener("click",function(){i<5&&(i+=.2,t.style.transform=`scale(${i})`)}),o.addEventListener("click",function(){i>.5&&(i-=.2,t.style.transform=`scale(${i})`)}),a.addEventListener("click",function(){i=1,t.style.transform=`scale(${i})`});let c=0,y=1;function u(e,t){let l=e.clientX-t.clientX,n=e.clientY-t.clientY;return Math.sqrt(l*l+n*n)}t.addEventListener("touchstart",function(e){2===e.touches.length&&(e.preventDefault(),c=u(e.touches[0],e.touches[1]),y=i)}),t.addEventListener("touchmove",function(e){if(2===e.touches.length){e.preventDefault();let l=u(e.touches[0],e.touches[1]),n=l/c*y;n>=.5&&n<=5&&(i=n,t.style.transform=`scale(${i})`)}})}(),window.preprocessEmojiEnhance=function(e,{portraitWidth:t=1080,portraitHeight:l=1354,toneBrightness:n=.8,toneRGBA:o="rgba(244,233,50,0.26)",unsharpRadius:a=53,unsharpStrength:i=2.9,finalFilter:s="brightness(1.18) contrast(1.05)",overlaySrc:r=""}={}){return new Promise((s,d)=>{let c=document.getElementById("preCropModal"),y=document.getElementById("preCropImage"),u=document.getElementById("instaCloseBtn"),g=document.getElementById("preCropDone"),p,m=URL.createObjectURL(e);y.src=m,c.style.display="flex",u.onclick=()=>{c.style.display="none",p?.destroy()},setTimeout(()=>{p=new Cropper(y,{aspectRatio:t/l,viewMode:1,background:!1,dragMode:"move",autoCropArea:1,movable:!0,zoomable:!0,cropBoxMovable:!1,cropBoxResizable:!1})},80),rotateBtn.onclick=()=>p.rotate(90),flipHBtn.onclick=()=>{let e=p.getData().scaleX||1;p.scaleX(-1*e)},flipVBtn.onclick=()=>{let e=p.getData().scaleY||1;p.scaleY(-1*e)},zoomInBtn.onclick=()=>p.zoom(.1),zoomOutBtn.onclick=()=>p.zoom(-.1),resetBtn.onclick=()=>p.reset(),g.onclick=()=>{let e=document.getElementById("mosaicLoader");e&&e.classList.add("active"),g.disabled=!0,g.style.opacity="0.5",g.style.cursor="not-allowed",setTimeout(()=>{try{let e=p.getCroppedCanvas({width:t,height:l}),y=document.createElement("canvas");y.width=t,y.height=l;let u=y.getContext("2d");u.filter=`brightness(${n})`,u.drawImage(e,0,0),u.globalCompositeOperation="multiply",u.fillStyle=o,u.fillRect(0,0,y.width,y.height),u.globalCompositeOperation="source-over",u.filter="none";let m=fx.canvas(),v=m.texture(y);m.draw(v).unsharpMask(a,i).update();let h=document.createElement("canvas");h.width=t,h.height=l;let $=h.getContext("2d");$.drawImage(m,0,0),window.__overlayImage&&r&&($.globalCompositeOperation="overlay",$.drawImage(window.__overlayImage,0,0,h.width,h.height),$.globalCompositeOperation="source-over"),c.style.display="none",p.destroy(),g.disabled=!1,g.style.opacity="1",g.style.cursor="pointer",s(h)}catch(f){console.error(f),g.disabled=!1,g.style.opacity="1",g.style.cursor="pointer",d(f)}},100)}})},window.__overlayImage=null,function(){let e=new Image;e.crossOrigin="anonymous",e.src="https://pub-158fe245ad374907b7bb850980fbef49.r2.dev/overlay.png",e.onload=()=>window.__overlayImage=e}(),document.getElementById("mosaicCloseBtn")?.addEventListener("click",()=>{let e=document.getElementById("mosaicModal");e&&(e.classList.remove("active"),document.body.style.overflow=""),document.getElementById("imageUpload").value=""}),document.getElementById("about-cta-btn").addEventListener("click",function(){document.getElementById("imageUpload").click()}),window.openCanvasLightbox=function(){let e=document.getElementById("mosaicCanvas");if(!e)return;let t=document.getElementById("lightboxModal"),l=document.getElementById("lightboxImage"),n=document.querySelector(".lightbox-loading");t.classList.add("active"),document.body.style.overflow="hidden",n&&(n.style.display="flex",n.innerHTML="⏳ Loading Full Resolution..."),l.style.opacity="0",setTimeout(()=>{let t=e.toDataURL("image/png",1);l.src=t,l.style.transform="scale(1)",l.onload=function(){l.style.opacity="1",n&&(n.style.display="none")}},50)},document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("downloadStandard"),t=document.getElementById("downloadUltraHD"),l=document.querySelector(".downloadStandard-mobile"),n=document.querySelector(".downloadUltraHD-mobile");l&&e&&l.addEventListener("click",function(){e.click(),syncButtonStates(e,l)}),n&&t&&n.addEventListener("click",function(){t.click(),syncButtonStates(t,n)})});
const fileInput=document.getElementById("imageUpload"),inputCanvas=document.getElementById("inputCanvas"),inputCtx=inputCanvas.getContext("2d"),outputContainer=document.getElementById("mosaicContainer"),tileSize=8;let imageLoaded=!1;function filenameToEmoji(e){let t=e.toLowerCase().split("/").pop().replace(/^emoji_u/,"").replace(/\.svg$/,"").split("_");return String.fromCodePoint(...t.map(e=>parseInt(e,16)))}async function renderFromResults(e,t,a,n,i=1){outputContainer.innerHTML="";let o=document.getElementById("mosaicCanvas");o||((o=document.createElement("canvas")).id="mosaicCanvas",outputContainer.appendChild(o)),o.width=t*n*4,o.height=a*n*4,o.style.width=t*n+"px",o.style.height=a*n+"px";let r=o.getContext("2d");r.scale(4,4),await document.fonts.load(`${n*i}px NotoEmoji`),r.fillStyle="#000",r.fillRect(0,0,o.width,o.height),r.font=`${n*i}px NotoEmoji`,r.textBaseline="top";let s=(n-n*i)/2,l=0;for(let d=0;d<a;d++)for(let c=0;c<t;c++,l++){let m=e[l]||"⬜";r.fillText(m,c*n+s,d*n+s)}let u=document.getElementById("mosaicModal"),p=document.getElementById("mosaicLoader");u&&(u.classList.add("active"),document.body.style.overflow="hidden"),p&&p.classList.remove("active"),o.style.cursor="pointer",o.addEventListener("click",function(){window.openCanvasLightbox()})}function resetMosaic(){outputContainer.innerHTML="",inputCtx.clearRect(0,0,inputCanvas.width,inputCanvas.height),fileInput.value="",imageLoaded=!1}function downloadUltraHD(){let e=document.getElementById("mosaicCanvas");if(!e)return alert("Please generate the mosaic first!");let t=document.getElementById("downloadUltraHD"),a=t.innerHTML,n=5;t.disabled=!0,t.style.opacity="0.7",t.style.cursor="not-allowed";let i=setInterval(()=>{if(t.innerHTML=`⏳ ${n}s...`,--n<0){clearInterval(i);let o=document.createElement("a");o.download="mosaic-ultra-hd.png",o.href=e.toDataURL("image/png"),o.click(),t.innerHTML=a,t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer"}},1e3)}function downloadStandard(){let e=document.getElementById("mosaicCanvas");if(!e)return alert("Please generate the mosaic first!");let t=document.getElementById("downloadStandard"),a=t.innerHTML,n=5;t.disabled=!0,t.style.opacity="0.7",t.style.cursor="not-allowed";let i=setInterval(()=>{if(t.innerHTML=`⏳ ${n}s...`,--n<0){clearInterval(i);let o=document.createElement("canvas");o.width=.62*e.width,o.height=.62*e.height;let r=o.getContext("2d");r.drawImage(e,0,0,o.width,o.height);let s=document.createElement("a");s.download="mosaic-standard.jpg",s.href=o.toDataURL("image/jpeg",.85),s.click(),t.innerHTML=a,t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer"}},1e3)}!async function e(){try{await loadWasmModule("build/full_mosaic.wasm"),await loadKDTreeIntoWasm("kd_tree.json")}catch(t){console.error("❌ WASM init failed:",t)}}(),fileInput.addEventListener("change",async e=>{let t=e.target.files&&e.target.files[0];if(t)try{let a=await window.preprocessEmojiEnhance(t,{portraitWidth:1080,portraitHeight:1354,toneBrightness:.8,toneRGBA:"rgba(244,233,50,0.26)",unsharpRadius:53,unsharpStrength:2.9,finalFilter:"brightness(1.18) contrast(1.05)",overlaySrc:!0});inputCanvas.width=a.width,inputCanvas.height=a.height,inputCtx.clearRect(0,0,inputCanvas.width,inputCanvas.height),inputCtx.drawImage(a,0,0),imageLoaded=!0,window.wasmReady||(await loadWasmModule("build/full_mosaic.wasm"),await loadKDTreeIntoWasm("kd_tree.json"));let{colors:n,cols:i,rows:o}=calculateTileColorsFromCanvas(inputCanvas,8),r=await matchEmojisInWorker(n);await renderFromResults(r=r.map(filenameToEmoji),i,o,8,.83)}catch(s){console.error("Preprocess/mosaic failed:",s),alert("Could not process image. Please try again.")}}),document.getElementById("downloadUltraHD").addEventListener("click",downloadUltraHD),document.getElementById("downloadStandard").addEventListener("click",downloadStandard);let mosaicWorker=null,workerReady=!1;function initWorker(){mosaicWorker||((mosaicWorker=new Worker("mosaic-worker.js")).onmessage=function(e){let{type:t}=e.data;"WASM_READY"===t&&(workerReady=!0)},mosaicWorker.onerror=function(e){workerReady=!1},mosaicWorker.postMessage({type:"INIT_WASM",data:{wasmPath:"build/full_mosaic.wasm",kdTreePath:"kd_tree.json"}}))}function matchEmojisInWorker(e){return new Promise((t,a)=>{if(!workerReady||!mosaicWorker){try{let n=runMatchingAndGetResults(e);t(n)}catch(i){a(i)}return}let o=function(n){let{type:i,results:r,error:s}=n.data;if("MATCH_COMPLETE"===i&&(mosaicWorker.removeEventListener("message",o),t(r)),"ERROR"===i){mosaicWorker.removeEventListener("message",o),console.error("Worker error, falling back to main thread:",s);try{let l=runMatchingAndGetResults(e);t(l)}catch(d){a(d)}}};mosaicWorker.addEventListener("message",o),mosaicWorker.postMessage({type:"MATCH_EMOJIS",data:{colors:e}})})}initWorker();